<html>
  <head>
    <title>Yv</title>
  </head>
  <style type='text/css'>
  </style>
  <body>
    <div style="height: 0px;width: 0px; overflow:hidden;">
      <input type="file" id="files">
    </div>
    <div id="menu"></div>
    <div id='canvas zone' style='position: relative;'>
        <canvas id='canvas' width='0px' height='0px'></canvas>
    </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="./reader.js"></script>
  <script src="./proc.js"></script>
  <script>
    var g_readers = [];
    var g_ctx = {
      'frame_num'  : 0,
      'num_frames' : 0,
      'reader_idx' : 0
    };

    function add(reader) {
      g_readers.push(reader);
      g_ctx.num_frames = 0;
      for (var i = 0; i < g_readers.length; ++i)
        g_ctx.num_frames = Math.max(g_ctx.num_frames, g_readers[i].num_frames);
      g_ctx.frame_num = Math.min(g_ctx.frame_num, g_ctx.num_frames - 1);

      var $btn = $('<button>', {class:'button-file'});
      $btn.data('reader_idx', g_readers.length - 1);
      $btn.click(function() {
        g_ctx.reader_idx = $(this).data('reader_idx');
        seek(g_ctx.frame_num);
      });
      $('#menu').append($btn);
      $btn.trigger('click');
    }

    function update() {
      $('.button-file').each(function(i, btn) {
        var idx = $(btn).data('reader_idx');
        var frame_num = g_readers[idx].frame_num;
        var num_frames = g_readers[idx].num_frames;
        var file_name = g_readers[idx].file.name;
        var text = file_name.slice(0, Math.min(4, file_name.length)) +
            ' ' + frame_num + '/' + (num_frames - 1);
        $(btn).html(text);
      });
    }

    function show() {
      var readers = [];
      readers.push(g_readers[g_ctx.reader_idx]);
      var rgb = proc(readers);
      var canvas = document.getElementById('canvas');
      canvas.width = rgb.width;
      canvas.height = rgb.height;
      canvas.getContext('2d').putImageData(rgb, 0, 0);
    }

    function seek(frame_num) {
      var num_seeked = 0;
      for (var i = 0; i < g_readers.length; ++i) {
        var seek_to = Math.min(frame_num, g_readers[i].num_frames - 1);
        g_readers[i].seek(seek_to, function() {
          num_seeked++;
          if (num_seeked == g_readers.length) {
            update();
            show();
          }
        });
      }
    }

    var keyCode = {
      LEFT: 37, RIGHT:39,
    };

    $(document).keydown(function(event) {
      switch(event.keyCode) {
        case keyCode.LEFT:
        case keyCode.RIGHT:
          g_ctx.frame_num = g_ctx.frame_num +
              (event.keyCode == keyCode.RIGHT? 1 : -1);
          g_ctx.frame_num = Math.max(
            Math.min(g_ctx.frame_num, g_ctx.num_frames - 1), 0);
          seek(g_ctx.frame_num);
        break;
      }
    });

    $('#files').change(function(e) {
      $('#open').remove();
      var reader = new FrameReader();
      reader.open(e.target.files[0], function(success) {
        if (success) {
          add(reader);
        } else {
          alert('Cannot open ' + e.target.files[0]);
        }
      });
    });

    $(document).ready(function() {
      var $elem = $('<button>', {text: 'Open'});
      $elem.click(function() {
        $('#files').trigger('click');
      });
      $('#menu').append($elem);
    });
  </script>
  </body>
</html>