<html>
  <head>
    <title>Yv</title>
  </head>
  <style type='text/css'>
  * {
    font-family:monospace;
  }
  </style>
  <body>
    <div style="height: 0px;width: 0px; overflow:hidden;">
      <input type="file" id="files">
    </div>
    <div id="menu"></div>
    <div id='canvas zone' style='position: relative;'>
        <canvas id='canvas' width='0px' height='0px'></canvas>
    </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="./reader.js"></script>
  <script src="./proc.js"></script>
  <script>
    var g_readers = [];
    var g_ctx = {
      'frame_num'  : 0,
      'num_frames' : 0,
      'reader_idx' : 0,
      'default_width' : 1280,
      'default_height': 720,
      'default_pix_fmt' : 'yv12'
    };

    function add(reader) {
      g_readers.push(reader);
      g_ctx.num_frames = 0;
      for (var i = 0; i < g_readers.length; ++i)
        g_ctx.num_frames = Math.max(g_ctx.num_frames, g_readers[i].num_frames);
      g_ctx.frame_num = Math.min(g_ctx.frame_num, g_ctx.num_frames - 1);

      var $btn = $('<button>', {class:'button-file'});
      $btn.data('reader_idx', g_readers.length - 1);
      $btn.click(function() {
        g_ctx.reader_idx = $(this).data('reader_idx');
        seek(g_ctx.frame_num);
      });
      $('#menu').append($btn);
      $btn.trigger('click');
    }

    function update() {
      $('.button-file').each(function(i, btn) {
        var idx = $(btn).data('reader_idx');
        var file_name = g_readers[idx].file.name;
        var text = file_name.slice(0, Math.min(4, file_name.length)) + ' ' +
            g_readers[idx].frame_num + '/' + (g_readers[idx].num_frames - 1);
        $(btn).html(text);
        $(btn).css('background-color','');
        $(btn).css('color','');

        if (idx == g_ctx.reader_idx) {
          $(btn).css('background-color','green');
          $(btn).css('color','white');

          var fmt = '' + g_readers[idx].width + 'x' + g_readers[idx].height +
              ' ' + g_readers[idx].pix_fmt;
          $('#fmt').val(fmt);
        }
      });
    }

    function show() {
      var readers = [];
      readers.push(g_readers[g_ctx.reader_idx]);
      var rgb = proc(readers);
      var canvas = document.getElementById('canvas');
      canvas.width = rgb.width;
      canvas.height = rgb.height;
      canvas.getContext('2d').putImageData(rgb, 0, 0);
    }

    function seek(frame_num) {
      var num_seeked = 0;
      for (var i = 0; i < g_readers.length; ++i) {
        var seek_to = Math.min(frame_num, g_readers[i].num_frames - 1);
        g_readers[i].seek(seek_to, function() {
          num_seeked++;
          if (num_seeked == g_readers.length) {
            update();
            show();
          }
        });
      }
    }

    var keyCode = {
      LEFT: 37, RIGHT:39,
    };

    $(document).keydown(function(key) {
      switch(key.which) {
        case keyCode.LEFT:
        case keyCode.RIGHT:
          g_ctx.frame_num = g_ctx.frame_num +
              (key.which == keyCode.RIGHT? 1 : -1);
          g_ctx.frame_num = Math.max(
            Math.min(g_ctx.frame_num, g_ctx.num_frames - 1), 0);
          seek(g_ctx.frame_num);
        break;
      }

      if (key.which >= 49 && key.which <= 57) {
        //#1..9
        var n = key.which - 49;
        if (n < g_readers.length) {
          var $btn = $('.button-file').filter(function() {
            return $(this).data('reader_idx') == n;
          });
          $btn.trigger('click');
        }
      }
    });

    $('#files').change(function(e) {
      $('#open').remove();
      var reader = new FrameReader();
      reader.open(e.target.files[0],
          function(success) {
            if (success) {
              add(reader);
            } else {
              alert('Cannot open ' + e.target.files[0]);
            }
          },
          g_ctx.default_width,
          g_ctx.default_height,
          g_ctx.default_pix_fmt
      );
    });

    $(document).ready(function() {
      var $open = $('<button>', {text: 'Open'});
      $open.click(function() {
        $('#files').trigger('click');
      });
      $('#menu').append($open);

      var $fmt = $('<input>', {type: 'text', id: 'fmt', css: {width:100}});
      $fmt.val('1280x720 yv12');
      $fmt.keydown(function(key) {
        key.stopPropagation();
        if (key.which == 13) {
          var fmt = $(this).val().toLowerCase();
          var m = fmt.match(/([\d]{1,4})x([\d]{1,4})/);
          if (m) {
            g_ctx.default_width = parseInt(m[1]);
            g_ctx.default_height = parseInt(m[2]);
          };

          m = fmt.match(/(yv12|i420|gray)/);
          if (m) {
            g_ctx.default_pix_fmt = m[1];
          }

          if (g_readers.length) {
            g_readers[g_ctx.reader_idx].open(
                g_readers[g_ctx.reader_idx].file,
                function() { seek(g_ctx.frame_num); },
                g_ctx.default_width,
                g_ctx.default_height,
                g_ctx.default_pix_fmt,
                true);
          }
        }
      });
      $('#menu').append($fmt);
    });
  </script>
  </body>
</html>
